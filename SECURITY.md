# セキュリティ対策について

## 🔒 APIキーの安全性

### ✅ **APIキーは完全に保護されています**

**現在の実装は安全です。理由：**

1. **サーバー側でのみ実行**
   - Gemini APIキーは`api/ai/*.ts`（Vercel Functions）でのみ使用
   - `process.env.GEMINI_API_KEY`は**サーバー側でのみアクセス可能**
   - ブラウザ（クライアント側）には**絶対に送信されません**

2. **クライアント側では使用されない**
   - `App.tsx`や`Login.tsx`などのクライアント側コードでは、APIキーを直接使用していません
   - クライアントは`/api/ai/*`エンドポイントを呼び出すだけ
   - APIキーはVercel Functions内で処理されます

3. **環境変数の分離**
   - **クライアント側用**: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`（`VITE_`プレフィックス）
   - **サーバー側用**: `GEMINI_API_KEY`（`VITE_`プレフィックスなし）
   - この命名規則により、クライアント側に誤って露出することを防いでいます

4. **GitHub上でも安全**
   - コードには`process.env.GEMINI_API_KEY`としか書かれていない
   - 実際のキーはVercelの環境変数に保存
   - `.env.local`は`.gitignore`に含まれているので、Gitにはプッシュされない

### ⚠️ **絶対にやってはいけないこと**

```typescript
// ❌ 危険！クライアント側で実行される
const VITE_GEMINI_API_KEY = "AIzaSy..." // コードに直接書く
```

```typescript
// ❌ 危険！クライアント側に露出する
const apiKey = import.meta.env.VITE_GEMINI_API_KEY; // クライアント側で使用
```

### ✅ **安全な実装（現在の実装）**

```typescript
// ✅ 安全！サーバー側でのみ実行される
// api/ai/feedback.ts（Vercel Functions）
const apiKey = process.env.GEMINI_API_KEY; // サーバー側でのみアクセス可能
```

## 実装済みのセキュリティ対策

### 1. 認証
- **Supabase認証**: ユーザー認証はSupabaseで管理されており、安全な認証システムを使用しています
- **フロントエンド認証チェック**: アプリケーションは認証状態を確認し、未認証ユーザーはアクセスできません

### 2. 入力値検証
- **コンテンツ長制限**: 日記の内容は最大10,000文字に制限されています
- **カスタム指示の長さ制限**: カスタム指示は最大500文字に制限されています
- **データ型検証**: APIエンドポイントで適切なデータ型を検証しています
- **Personality値の検証**: 許可された値のみを受け入れます

### 3. CORS設定
- **開発環境**: すべてのオリジンを許可（開発用）
- **本番環境**: Vercel Functionsは自動的にCORSを処理します

## 本番環境での推奨設定

### 1. サーバー側認証の追加（推奨）
現在、フロントエンドでのみ認証チェックが行われています。より強固なセキュリティのため、サーバー側でもSupabase JWTトークンを検証することを推奨します。

### 2. CORS設定の変更
`server.ts`のCORS設定を本番環境に合わせて変更してください：

```typescript
app.use(
  cors({
    origin: process.env.ALLOWED_ORIGINS?.split(',') || ['https://yourdomain.com'],
    credentials: true,
  })
);
```

### 3. 環境変数の保護
- APIキーや秘密鍵は環境変数で管理してください（`.env.local`ファイル）
- `.env.local`ファイルはGitにコミットしないでください
- 本番環境では、適切な環境変数管理サービスを使用してください

### 4. HTTPSの使用
本番環境では必ずHTTPSを使用してください。

### 5. レートリミッティング（オプション）
大量のリクエストを防ぐため、`express-rate-limit`などのレートリミッティングミドルウェアの導入を検討してください。

### 6. データベースセキュリティ
- SupabaseのRLS（Row Level Security）ポリシーを適切に設定してください
- 必要に応じて、データベースへの直接アクセスを制限してください

## 注意事項

- 現在の実装は開発環境向けです
- 本番環境にデプロイする前に、上記の推奨設定を確認・実装してください
- 定期的にセキュリティアップデートを確認してください



